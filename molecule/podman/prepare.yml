---
- name: Prepare hosts
  hosts: all
  gather_facts: false
  tasks:
    - name: Read /etc/os-release
      ansible.builtin.raw: /bin/cat /etc/os-release
      register: osrel
      changed_when: false

    - name: Extract distro ID
      ansible.builtin.set_fact:
        distro_id: >-
          {{ (osrel.stdout_lines
              | select('match','^ID=')
              | list | first
              | regex_replace('^ID="?([^"]+)"?.*','\1')
              | lower) }}

    - name: Ensure /tmp exists and writable
      ansible.builtin.raw: /bin/sh -lc 'mkdir -p /tmp && chmod 1777 /tmp'
      changed_when: false

    - name: Install Python3 on Debian/Ubuntu
      ansible.builtin.raw: >
        /bin/sh -lc 'export DEBIAN_FRONTEND=noninteractive;
        apt-get update;
        apt-get install -y python3 python3-apt ca-certificates curl'
      when: distro_id in ['debian','ubuntu']
      changed_when: false

    - name: Install Python 3.9 on RHEL-like
      ansible.builtin.raw: >
        /bin/sh -lc '
        if command -v dnf >/dev/null 2>&1; then
          dnf -y module enable python39 || true;
          dnf -y install python39 ca-certificates curl;
        elif command -v yum >/dev/null 2>&1; then
          yum -y install python39 ca-certificates curl;
        else
          echo "No dnf/yum found" >&2; exit 1;
        fi'
      when: distro_id in ['ol','oraclelinux','rhel','centos','rocky','almalinux']
      changed_when: false

    - name: Make python3 point to python3.9 on RHEL-like
      ansible.builtin.raw: /bin/sh -lc 'if [ -x /usr/bin/python3.9 ]; then ln -sfn /usr/bin/python3.9 /usr/bin/python3; fi'
      when: distro_id in ['ol','oraclelinux','rhel','centos','rocky','almalinux']
      changed_when: false
